<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LumaAI, three.js, and WebGL</title>
    <style>
        

        #vr-button-container {
            position: absolute;
            bottom: 100px; /* Adjust this value as needed */
            left: 50%; /* Adjust this value as needed */
            z-index: 2; /* Ensure VR button is above canvas */
            transform: translateX(-50%); /* Center horizontally */
        }
    </style>
</head>
<body>
    <div id="vr-button-container"></div>
    <canvas></canvas>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/",
                "@lumaai/luma-web": "https://unpkg.com/@lumaai/luma-web@0.2.0/dist/library/luma-web.module.js"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three'; 
        import { WebGLRenderer, PerspectiveCamera, Scene } from 'three';
       // import { OrbitControls } from '/libs/OrbitControls.js';
        import { LumaSplatsThree } from '@lumaai/luma-web';
        import { VRButton } from '/libs/VRButton.js';
        import { XRControllerModelFactory } from '/libs/XRControllerModelFactory.js';
        var width = window.innerWidth;
        var height = window.innerHeight;
    
        let canvas = document.querySelector('canvas');
        let renderer, scene, camera, controller1, controller2, controllerGrip1, controllerGrip2;
        function createRenderer() {
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(width, height);
            renderer.outputEncoding = THREE.sRGBEncoding;  //Enable the XR 
            renderer.xr.enabled = true;
            renderer.shadowMap.enabled = true;
            renderer.setClearColor(0x000000, 1.0);
            canvas.appendChild(renderer.domElement);
            canvas.appendChild(VRButton.createButton(renderer));
            console.log('Renderer created');
        }
        //Make the scene
        function createScene() {
            scene = new THREE.Scene();
            console.log('scene created');
        }
                //Make the camera
        function createCamera(){
            camera = new THREE.PerspectiveCamera(75,window.innerWidth / window.innerHeight,0.1, 1000);
           
            //const helper = new THREE.CameraHelper(camera);
           // cameraControl = new OrbitControls(camera, renderer.domElement);
           // camera.add( listener );
           // scene.add(helper);
            scene.add(camera);
            //camera.lookAt(scene.position);
            console.log('camera created');
        }

       
       // let controls = new OrbitControls(camera, canvas);
       // controls.enableDamping = true;
    function createSplat(){
        let splat = new LumaSplatsThree({
            source: 'https://lumalabs.ai/capture/d80d4876-cf71-4b8a-8b5b-49ffac44cd4a'
            
        });
        scene.add(splat);
    }
        
    
   
       // Function to create VR controllers
       function createVRControllers() {
            function onSelectStart() {
                this.children[0].scale.z = 10;
                this.userData.isSelecting = true; 
            }
            function onSelectEnd() {
                this.children[0].scale.z = 0;
                this.userData.isSelecting = false;
            }  
    
            // Set up controller 1 
            let controller1 = renderer.xr.getController(0);
            controller1.addEventListener('selectstart', onSelectStart);
            controller1.addEventListener('selectend', onSelectEnd);
            controller1.addEventListener('connected', function(event) {
                this.add(buildController(event.data));
            });
            controller1.addEventListener('disconnected', function() { this.remove(this.children[0]); });
            scene.add(controller1);
    
            // Set up controller 2
            let controller2 = renderer.xr.getController(1);
            controller2.addEventListener('selectstart', onSelectStart);
            controller2.addEventListener('selectend', onSelectEnd);
            controller2.addEventListener('connected', function(event) {
                this.add(buildController(event.data));
            });
            controller2.addEventListener('disconnected', function() { this.remove(this.children[0]); });
            scene.add(controller2);
    
            const controllerModelFactory = new XRControllerModelFactory();
            let controllerGrip1 = renderer.xr.getControllerGrip(0);
            controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
            scene.add(controllerGrip1);
    
            let controllerGrip2 = renderer.xr.getControllerGrip(1);
            controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
            scene.add(controllerGrip2);
            
            window.addEventListener('resize', onWindowResize, false);
    
            function buildController(data) {
                let geometry, material;
                switch (data.targetRayMode) {
                    case 'tracked-pointer':
                        geometry = new THREE.BufferGeometry();
                        geometry.setAttribute('position', new THREE.Float32BufferAttribute([0, 0, 0, 0, 0, -1], 3));
                        geometry.setAttribute('color', new THREE.Float32BufferAttribute([0.5, 0.5, 0.5, 0, 0, 0], 3));
                        material = new THREE.LineBasicMaterial({ vertexColors: true, blending: THREE.AdditiveBlending });
                        return new THREE.Line(geometry, material);
                    case 'gaze':
                        geometry = new THREE.RingBufferGeometry(0.02, 0.04, 32).translate(0, 0, -1);
                        material = new THREE.MeshBasicMaterial({ opacity: 0.5, transparent: true });
                        return new THREE.Mesh(geometry, material);
                }
            }
        }
        
    
        // Add the VR button to the container
        let vrButtonContainer = document.getElementById('vr-button-container');
        vrButtonContainer.appendChild(VRButton.createButton(renderer));
    
     
        function onWindowResize() {
            width = window.innerWidth;
            height = window.innerHeight;
           // camera.updateProjectionMatrix();
            //renderer.setSize(width, height);
            console.log('window size changed');
         }
    
        window.addEventListener('resize', onWindowResize);
        onWindowResize(); // Call once to set initial size
    
        // Animation loop
        function animate() {
            controls.update();
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }
        //initialise all the stuff
        function init() {
            
            createScene();
            createRenderer();
            createCamera();
            window.addEventListener("resize", onWindowResize, false);
            //createLight();
            createSplat()
            createVRControllers();
            animate();// Start animation loop
        }
        
        init();
    </script>
</body>
</html>


